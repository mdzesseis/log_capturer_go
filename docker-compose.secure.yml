services:
  # SSW Logs Capture Go - Main Application (SECURE VERSION)
  log_capturer_go:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - DOCKER_GID=${DOCKER_GID:-999}
    container_name: log_capturer_go
    restart: unless-stopped
    # REMOVED: privileged: true - SECURITY RISK
    # REMOVED: user: "0:0" - Running as root is dangerous
    user: "1000:999"  # appuser:docker group
    # Override container command to use config file
    command: ["./ssw-logs-capture", "--config", "/app/configs/config.yaml"]
    environment:
      # Configuration overrides for Docker Compose
      - SSW_CONFIG_FILE=/app/configs/config.yaml
      - SSW_PIPELINES_FILE=/app/configs/pipelines.yaml
      - SSW_FILE_CONFIG=/app/configs/file_pipeline.yml
      - SERVER_HOST=0.0.0.0
      - METRICS_HOST=0.0.0.0
      - LOKI_URL=http://loki:3100
      - DOCKER_SOCKET_PATH=unix:///var/run/docker.sock
      - DOCKER_GID=${DOCKER_GID:-999}
      - LOG_LEVEL=info  # Changed from debug for production
      - LOG_FORMAT=json
      - DEBUG_MODE=false  # Disabled for production
    ports:
      - "127.0.0.1:8401:8401"  # Bind only to localhost for security
      - "127.0.0.1:8001:8001"  # Bind only to localhost for security
    volumes:
      # Docker socket with proper permissions
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs:/app/configs:ro
      # Use named volumes for better security and performance
      - log_data:/logs
      - container_data:/var/lib/docker/containers:ro
      - app_data:/app/data
      - dlq_data:/app/dlq
      - batch_data:/app/batch_persistence
      - debug_data:/app/debug
      - /var/log:/var/log:ro
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - logs-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8401/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE  # Only needed capability for log file reading
    read_only: false  # Needs write access for positions and DLQ
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Alternative: Ultra-secure version with sidecar
  log_capturer_go_sidecar:
    build:
      context: .
      dockerfile: Dockerfile.sidecar
    container_name: log_capturer_go_sidecar
    restart: unless-stopped
    user: "1000:1000"  # Non-root user without docker group
    environment:
      - SSW_CONFIG_FILE=/app/configs/config.yaml
      - LOKI_URL=http://loki:3100
      - LOG_LEVEL=info
      - LOG_FORMAT=json
    ports:
      - "127.0.0.1:8401:8401"
      - "127.0.0.1:8001:8001"
    volumes:
      - ./configs:/app/configs:ro
      - log_data:/logs:ro  # Read-only access to logs
      - app_data:/app/data
    depends_on:
      - docker_log_forwarder
      - loki
    networks:
      - logs-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    profiles:
      - ultra-secure

  # Docker log forwarder sidecar (for ultra-secure setup)
  docker_log_forwarder:
    image: fluent/fluent-bit:3.0
    container_name: docker_log_forwarder
    restart: unless-stopped
    user: "0:999"  # Needs root for docker socket, but limited scope
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./configs/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - log_data:/logs
    networks:
      - logs-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
    profiles:
      - ultra-secure

  # Test runner (already secure)
  test_runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: ssw-logs-capture-test
    restart: "no"
    user: "1000:1000"  # Run as non-root
    environment:
      - COVERAGE_THRESHOLD=94
      - TEST_TIMEOUT=10m
      - DAEMON_MODE=false
      - GO_ENV=test
    ports:
      - "127.0.0.1:9090:9090"  # Bind only to localhost
    volumes:
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage
      - ./test-data:/app/test-data:ro
    networks:
      - logs-network
    profiles:
      - testing
    command: ["test-runner.sh", "all"]
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Loki Storage Monitor (SECURED)
  loki-monitor:
    build:
      context: .
      dockerfile: Dockerfile.loki-monitor
    container_name: loki-monitor
    restart: unless-stopped
    user: "1000:1000"  # Run as non-root
    volumes:
      - loki_data:/loki:ro
      - ./scripts:/scripts:ro
      - loki_monitoring:/tmp/monitoring
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - TZ=UTC  # Use UTC for consistency
      - LOKI_DATA_DIR=/loki
      - MAX_SIZE_GB=5
      - CLEANUP_THRESHOLD_PERCENT=80
      - CHECK_INTERVAL=300  # 5 minutes
      - LOKI_API_URL=http://loki:3100
      - METRICS_OUTPUT_DIR=/tmp/monitoring
      - METRICS_PORT=9091
    ports:
      - "127.0.0.1:9091:9091"  # Bind only to localhost
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - logs-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false  # Needs write access to metrics directory
    tmpfs:
      - /tmp:noexec,nosuid,size=50m

  # Grafana Loki - Log aggregation system (SECURED)
  loki:
    image: grafana/loki:3.5.3
    container_name: loki
    restart: unless-stopped
    user: "10001:10001"  # Non-root user
    ports:
      - "127.0.0.1:3100:3100"  # Bind only to localhost
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    environment:
      - TZ=UTC
      - LOKI_MAX_DATA_SIZE=5GB
      - LOKI_CLEANUP_ENABLED=true
    networks:
      - logs-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false  # Loki needs write access
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Grafana (SECURED)
  grafana:
    image: grafana/grafana:11.4.0
    container_name: grafana
    restart: unless-stopped
    user: "472:472"  # Grafana user
    ports:
      - "127.0.0.1:3000:3000"  # Bind only to localhost
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_SECURITY_ALLOW_EMBEDDING=false
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=strict
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning:ro
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - logs-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Prometheus (SECURED)
  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: prometheus
    restart: unless-stopped
    user: "65534:65534"  # nobody user
    ports:
      - "127.0.0.1:9090:9090"  # Bind only to localhost
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - logs-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

# Named volumes for better security and data persistence
volumes:
  loki_data:
    driver: local
  grafana_data:
    driver: local
  prometheus_data:
    driver: local
  log_data:
    driver: local
  container_data:
    driver: local
  app_data:
    driver: local
  dlq_data:
    driver: local
  batch_data:
    driver: local
  debug_data:
    driver: local
  loki_monitoring:
    driver: local

# Isolated network
networks:
  logs-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16