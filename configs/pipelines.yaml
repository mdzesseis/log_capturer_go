# =============================================================================
# SSW LOGS CAPTURE - PIPELINE CONFIGURATION OPTIMIZED FOR LOKI
# =============================================================================
# Pipelines otimizados para Loki com baixa cardinalidade de labels
# Garantem sempre: level, msg, timestamp em todos os logs
# =============================================================================

pipelines:
  # Pipeline padrão - fallback para logs não categorizados
  - name: default
    description: "Pipeline padrão com campos essenciais"
    steps:
      - name: extract_level
        type: log_level_extract
        config:
          pattern: '(?i)\b(trace|debug|info|warn|warning|error|fatal|crit|critical)\b'
          field: level

      - name: ensure_msg_field
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: add_standard_labels
        type: field_add
        config:
          fields:
            service: "log-capturer"
            pipeline: "default"

  # Pipeline para MySQL Database
  - name: mysql
    description: "Pipeline para logs do MySQL"
    steps:
      - name: extract_mysql_timestamp
        type: timestamp_parse
        config:
          format: "2006-01-02T15:04:05.000000Z"
          field: message
          use_as_log_timestamp: true
          timezone: "UTC"

      - name: extract_mysql_level
        type: regex_extract
        config:
          pattern: '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z\s+\d+\s+\[(Note|Warning|Error)\]'
          fields: ["level"]

      - name: extract_mysql_msg
        type: regex_extract
        config:
          pattern: '^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)\s+\d+\s+\[(?:Note|Warning|Error)\]\s+(.+)'
          fields: ["_temp_time", "msg"]

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: normalize_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: add_mysql_labels
        type: field_add
        config:
          fields:
            service: "mysql"
            component: "database"

  # Pipeline para FreeSWITCH
  - name: freeswitch
    description: "Pipeline para logs do FreeSWITCH"
    steps:
      - name: clean_ansi_codes
        type: regex_extract
        config:
          pattern: '\x1b\[[0-9;]*m'
          fields: []

      - name: extract_freeswitch_data
        type: regex_extract
        config:
          pattern: '^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d+)\s+[\d.%]+\s+\[(\w+)\]\s+(.+)'
          fields: ["_temp_time", "level", "msg"]

      - name: parse_freeswitch_timestamp
        type: timestamp_parse
        config:
          field: "_temp_time"
          format: "2006-01-02 15:04:05.000000"
          use_as_log_timestamp: true
          timezone: "UTC"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: normalize_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: add_freeswitch_labels
        type: field_add
        config:
          fields:
            service: "freeswitch"
            component: "voip"

  # Pipeline para Grafana
  - name: grafana
    description: "Pipeline para logs do Grafana"
    steps:
      - name: extract_grafana_structured
        type: regex_extract
        config:
          pattern: 'logger=([^\s]+).*t=(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[^\s]+).*level=(\w+).*msg="([^"]+)"'
          fields: ["_temp_logger", "_temp_time", "level", "msg"]

      - name: parse_grafana_timestamp
        type: timestamp_parse
        config:
          field: "_temp_time"
          format: "2006-01-02T15:04:05.000000000Z"
          use_as_log_timestamp: true
          timezone: "UTC"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: normalize_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: add_grafana_labels
        type: field_add
        config:
          fields:
            service: "grafana"
            component: "monitoring"

  # Pipeline para Prometheus
  - name: prometheus
    description: "Pipeline para logs do Prometheus"
    steps:
      - name: extract_prometheus_structured
        type: regex_extract
        config:
          pattern: 'level=(\w+).*ts=(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[^\s]+).*msg="([^"]+)"'
          fields: ["level", "_temp_time", "msg"]

      - name: parse_prometheus_timestamp
        type: timestamp_parse
        config:
          field: "_temp_time"
          format: "2006-01-02T15:04:05.000Z"
          use_as_log_timestamp: true
          timezone: "UTC"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: normalize_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: add_prometheus_labels
        type: field_add
        config:
          fields:
            service: "prometheus"
            component: "monitoring"

  # Pipeline para JSON logs (log_generator, loki-monitor)
  - name: json_logs
    description: "Pipeline para logs em formato JSON"
    steps:
      - name: extract_json_fields
        type: regex_extract
        config:
          pattern: '"timestamp":"([^"]+)".*"level":"([^"]+)".*"message":"([^"]+)"'
          fields: ["_temp_time", "level", "msg"]

      - name: parse_json_timestamp
        type: timestamp_parse
        config:
          field: "_temp_time"
          formats:
            - "2006-01-02T15:04:05+00:00"
            - "2006-01-02T15:04:05Z"
            - "2006-01-02T15:04:05.000Z"
          use_as_log_timestamp: true
          timezone: "UTC"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: normalize_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: add_json_labels
        type: field_add
        config:
          fields:
            service: "application"
            component: "app"

  # Pipeline para syslog - CORRIGIDO
  - name: syslog
    description: "Pipeline para logs do syslog"
    steps:
      - name: extract_syslog_fields
        type: regex_extract
        config:
          pattern: '^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+[+-]\d{2}:\d{2})\s+(\S+)\s+([^:]+):\s*(.+)$'
          fields: ["_temp_time", "_temp_hostname", "_temp_process", "msg"]

      - name: parse_syslog_timestamp
        type: timestamp_parse
        config:
          field: "_temp_time"
          format: "2006-01-02T15:04:05.000000-07:00"
          use_as_log_timestamp: true
          timezone: "Local"

      - name: extract_syslog_level
        type: log_level_extract
        config:
          pattern: '(?i)\b(debug|info|warn|warning|error|fatal|crit|critical)\b'
          field: level

      - name: fallback_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: add_syslog_labels
        type: field_add
        config:
          fields:
            service: "system"
            component: "syslog"

  # Pipeline para kernel logs
  - name: kernel
    description: "Pipeline para logs do kernel"
    steps:
      - name: extract_kernel_data
        type: regex_extract
        config:
          pattern: '^\[(\s*\d+\.\d+)\]\s+(.+)'
          fields: ["_temp_uptime", "msg"]

      - name: extract_kernel_level
        type: log_level_extract
        config:
          pattern: '(?i)\b(debug|info|warn|warning|error|fatal|crit|critical|emerg)\b'
          field: level

      - name: fallback_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: fallback_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: add_kernel_labels
        type: field_add
        config:
          fields:
            service: "kernel"
            component: "system"

  # Pipeline para monitoramento de arquivos - NOVO
  - name: file_monitoring
    description: "Pipeline para logs capturados de arquivos"
    steps:
      - name: add_file_metadata
        type: field_add
        config:
          fields:
            file_path: "{{source_path}}"
            file_name: "{{source_filename}}"

      - name: extract_general_level
        type: log_level_extract
        config:
          pattern: '(?i)\b(trace|debug|info|warn|warning|error|fatal|crit|critical|emerg)\b'
          field: level

      - name: fallback_level
        type: field_add
        config:
          fields:
            level: "info"

      - name: ensure_msg
        type: field_add
        config:
          fields:
            msg: "{{message}}"

      - name: add_file_labels
        type: field_add
        config:
          fields:
            service: "file-monitor"
            component: "files"

# =============================================================================
# MAPEAMENTO DE SOURCES PARA PIPELINES - OTIMIZADO
# =============================================================================
source_mapping:
  # Container mappings - baixa cardinalidade
  mysql:
    - "container_name:mysql"
    - "mysql"

  freeswitch:
    - "container_name:freeswitch"
    - "freeswitch"

  grafana:
    - "container_name:grafana"
    - "grafana"

  prometheus:
    - "container_name:prometheus"
    - "prometheus"

  json_logs:
    - "container_name:log_generator"
    - "container_name:loki-monitor"
    - "log_generator"
    - "loki-monitor"

  # File mappings
  syslog:
    - "file_path:/var/log/syslog"
    - "source_type:file"

  kernel:
    - "file_path:/var/log/kern.log"
    - "file_path:/var/log/dmesg"

  file_monitoring:
    - "file_path:/var/log/auth.log"
    - "source_type:file"