# =============================================================================
# CONFIGURAÇÃO COMPLETA - SSW LOGS CAPTURE GO
# =============================================================================
# Este arquivo contém todas as configurações possíveis para o log_capturer
# Versão: Go 1.21+
# Data: 2025-09-22
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES GERAIS DA APLICAÇÃO
# -----------------------------------------------------------------------------
app:
  # Nome da aplicação (usado em logs e métricas)
  name: "ssw-logs-capture"

  # Versão da aplicação
  version: "v0.0.2"

  # Ambiente de execução (development, staging, production)
  environment: "production"

  # Nível de log global (trace, debug, info, warn, error, fatal, panic)
  log_level: "debug"

  # Formato dos logs (json, text)
  log_format: "json"

  # Arquivo de log da aplicação (deixe vazio para stdout)
  log_file: ""

  # Timeout geral para operações (formato: 30s, 5m, 1h)
  operation_timeout: "1h"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DO SERVIDOR HTTP
# -----------------------------------------------------------------------------
server:
  # Porta do servidor HTTP principal
  port: 8401

  # Host/IP para bind do servidor (0.0.0.0 para todas as interfaces)
  host: "0.0.0.0"

  # Timeout para leitura de requests
  read_timeout: "30s"

  # Timeout para escrita de responses
  write_timeout: "30s"

  # Timeout para idle connections
  idle_timeout: "60s"

  # Tamanho máximo do header do request
  max_header_bytes: 1048576  # 1MB

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE MÉTRICAS PROMETHEUS
# -----------------------------------------------------------------------------
metrics:
  # Habilitar coleta de métricas
  enabled: true

  # Porta do servidor de métricas
  port: 8001

  # Host/IP para métricas
  host: "0.0.0.0"

  # Path do endpoint de métricas
  path: "/metrics"

  # Prefixo para todas as métricas
  prefix: "ssw_logs_capture"

  # Intervalo de coleta de métricas do sistema
  collection_interval: "15s"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE MONITORAMENTO DE ARQUIVOS
# -----------------------------------------------------------------------------
file_monitor:
  # Habilitar monitoramento de arquivos
  enabled: true

  # Diretórios para monitorar (lista de paths)
  watch_directories:
    - "/var/log"
    - "/app/logs"

  # Padrões de arquivos para incluir (glob patterns)
  include_patterns:
    - "*.log"
    - "*.txt"
    - "access_log*"
    - "error_log*"

  # Padrões de arquivos para excluir
  exclude_patterns:
    - "*.gz"
    - "*.zip"
    - "*~"
    - ".tmp*"

  # Intervalo de polling para mudanças em arquivos
  poll_interval: "1s"

  # Tamanho do buffer de leitura por arquivo
  read_buffer_size: 65536  # 64KB

  # Intervalo entre leituras do mesmo arquivo
  read_interval: "100ms"

  # Procurar recursivamente em subdiretórios
  recursive: true

  # Seguir symlinks
  follow_symlinks: false

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE MONITORAMENTO DE CONTAINERS
# -----------------------------------------------------------------------------
container_monitor:
  # Habilitar monitoramento de containers Docker
  enabled: true

  # Socket do Docker (unix:// ou tcp://)
  socket_path: "unix:///var/run/docker.sock"

  # Timeout para operações Docker
  health_check_delay: "30s"
  reconnect_interval: "30s"
  max_concurrent: 50

  # Labels de containers para incluir (filtros)
  include_labels:
    # - "logging.enabled=true"
    # - "environment=production"

  # Labels de containers para excluir
  exclude_labels:
    # - "logging.disabled=true"
    # - "no-logs=true"

  # Nomes de containers para incluir (regex)
  include_names:
    # - "app-.*"
    # - "web-.*"
    # - "api-.*"

  # Nomes de containers para excluir (regex)
  exclude_names:
    - "log_capturer_go"  # Evitar monitoring circular do próprio container
    # - ".*-test"
    # - ".*-temp"

  # Incluir logs do stdout do container
  include_stdout: true

  # Incluir logs do stderr do container
  include_stderr: true

  # Número máximo de linhas para ler por vez
  tail_lines: 100

  # Seguir logs em tempo real
  follow: true

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DO DISPATCHER (ROTEAMENTO)
# -----------------------------------------------------------------------------
dispatcher:
  # Tamanho da fila interna do dispatcher
  queue_size: 10000

  # Número de workers para processar a fila
  worker_count: 4

  # Timeout para envio para sinks
  send_timeout: "10s"

  # Tamanho do batch para envios em lote
  batch_size: 100

  # Intervalo máximo para flush de batch (mesmo que não esteja cheio)
  batch_timeout: "5s"

  # Número máximo de tentativas de reenvio
  max_retries: 3

  # Intervalo base para retry exponential backoff
  retry_base_delay: "1s"

  # Multiplicador para retry exponential backoff
  retry_multiplier: 2

  # Delay máximo entre retries
  retry_max_delay: "30s"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DOS SINKS (DESTINOS)
# -----------------------------------------------------------------------------
sinks:
  # -------------------------
  # LOKI SINK
  # -------------------------
  loki:
    # Habilitar sink do Loki
    enabled: true

    # URL do servidor Loki
    url: "http://loki:3100"

    # Endpoint para push de logs
    push_endpoint: "/loki/api/v1/push"

    # Tenant ID (para Loki multi-tenant)
    tenant_id: ""

    # Timeout para requests HTTP
    timeout: "30s"

    # Tamanho máximo do batch
    batch_size: 1000

    # Timeout para flush do batch
    batch_timeout: "10s"

    # Tamanho máximo de cada request em bytes
    max_request_size: 1048576  # 1MB

    # Labels padrão para todos os logs
    default_labels:
      service: "ssw-logs-capture"
      environment: "production"
      version: "v0.0.2"

    # Headers HTTP adicionais
    headers:
      "User-Agent": "ssw-logs-capture/v0.0.2"
      "Content-Type": "application/json"

    # Configurações de autenticação
    auth:
      # Tipo de auth (none, basic, bearer)
      type: "none"
      username: ""
      password: ""
      token: ""

    # Configurações de TLS
    tls:
      enabled: false
      verify_certificate: true
      ca_file: ""
      cert_file: ""
      key_file: ""

  # -------------------------
  # LOCAL FILE SINK
  # -------------------------
  local_file:
    # Habilitar sink de arquivo local
    enabled: true

    # Diretório base para arquivos de log
    directory: "/app/logs/output"

    # Padrão do nome do arquivo (suporta variáveis de tempo)
    filename_pattern: "logs-{date}-{hour}.log"

    # Formato de saída (json, text)
    output_format: "text"

    # Configurações para formato text
    text_format:
      # Incluir timestamp nos logs de texto
      include_timestamp: true

      # Formato do timestamp (layout Go time)
      timestamp_format: "2006-01-02 15:04:05.000"

      # Incluir labels nos logs de texto
      include_labels: true

      # Separador entre campos no formato texto
      field_separator: " | "

    # Rotação de arquivos
    rotation:
      # Habilitar rotação por tamanho
      enabled: true

      # Tamanho máximo por arquivo em MB
      max_size_mb: 100

      # Número máximo de arquivos a manter
      max_files: 10

      # Dias de retenção
      retention_days: 7

      # Comprimir arquivos antigos
      compress: true

    # Sync automático para disk (fsync)
    auto_sync: true

    # Intervalo para sync forçado
    sync_interval: "30s"

    # Permissões do arquivo (formato octal)
    file_permissions: 0644

    # Permissões do diretório (formato octal)
    dir_permissions: 0755

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE PROCESSAMENTO DE LOGS
# -----------------------------------------------------------------------------
processing:
  # Habilitar pipeline de processamento
  enabled: true

  # Arquivo de configuração dos pipelines
  pipelines_file: "pipelines.yaml"

  # Número de workers para processamento
  worker_count: 2

  # Tamanho da fila de processamento
  queue_size: 5000

  # Timeout para processamento de cada log
  processing_timeout: "5s"

  # Pular logs que falham no processamento
  skip_failed_logs: true

  # Enriquecer logs com informações do sistema
  enrich_logs: true

  # Informações de enriquecimento
  enrichment:
    # Adicionar hostname
    add_hostname: true

    # Adicionar timestamp de processamento
    add_processing_timestamp: true

    # Adicionar ID único para cada log
    add_unique_id: true

    # Adicionar informações de fonte
    add_source_info: true

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE LIMPEZA DE DISCO
# -----------------------------------------------------------------------------
cleanup:
  # Habilitar gerenciamento de limpeza de disco
  enabled: true

  # Intervalo entre execuções de limpeza
  cleanup_interval: "1h"

  # Configurações por diretório
  directories:
    - # Diretório de logs de saída
      path: "/app/logs/output"

      # Tamanho máximo total do diretório em MB
      max_size_mb: 1024

      # Número máximo de arquivos
      max_files: 100

      # Dias de retenção (arquivos mais antigos são removidos)
      retention_days: 7

      # Padrões de arquivos para limpeza
      file_patterns:
        - "*.log"
        - "*.log.*"

    - # Diretório de DLQ
      path: "/app/dlq"
      max_size_mb: 256
      max_files: 50
      retention_days: 14
      file_patterns:
        - "dlq-*.log"

    - # Diretório temporário
      path: "/tmp/ssw-logs"
      max_size_mb: 100
      max_files: 20
      retention_days: 1
      file_patterns:
        - "*"

  # Configurações de alertas de espaço em disco
  disk_space_monitoring:
    # Habilitar monitoramento de espaço
    enabled: true

    # Percentual de uso para alerta de warning
    warning_threshold_percent: 80

    # Percentual de uso para alerta crítico
    critical_threshold_percent: 90

    # Intervalo de verificação de espaço
    check_interval: "5m"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE GERENCIAMENTO DE POSIÇÕES
# -----------------------------------------------------------------------------
positions:
  # Habilitar gerenciamento de posições (containers e arquivos)
  enabled: true

  # Diretório para salvar arquivos de posições
  directory: "/app/data/positions"

  # Intervalo para flush do buffer em memória para disco
  flush_interval: "30s"

  # Número máximo de posições em buffer na memória
  max_memory_buffer: 1000

  # Forçar flush final ao sair da aplicação
  force_flush_on_exit: true

  # Intervalo de limpeza de posições antigas
  cleanup_interval: "5m"

  # Idade máxima de posições para manter no sistema
  max_position_age: "24h"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE DEDUPLICAÇÃO
# -----------------------------------------------------------------------------
deduplication:
  # Habilitar sistema de deduplicação
  enabled: true

  # Tamanho máximo do cache LRU
  max_cache_size: 100000

  # TTL para entradas no cache
  ttl: "1h"

  # Intervalo de limpeza de entradas expiradas
  cleanup_interval: "10m"

  # Algoritmo de hash (sha256, md5, sha1)
  hash_algorithm: "sha256"

  # Incluir timestamp no hash (reduz efetividade da deduplicação)
  include_timestamp: false

  # Incluir source ID no hash
  include_source_id: true

  # Configurações de hash customizado
  hash_config:
    # Campos a incluir no hash além da mensagem
    include_fields:
      - "level"
      - "logger"

    # Ignorar diferenças de case
    ignore_case: false

    # Normalizar whitespace
    normalize_whitespace: true

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE DEAD LETTER QUEUE (DLQ)
# -----------------------------------------------------------------------------
dlq:
  # Habilitar Dead Letter Queue
  enabled: true

  # Diretório para arquivos DLQ
  directory: "/app/dlq"

  # Tamanho máximo de cada arquivo DLQ em bytes
  max_file_size: 10485760  # 10MB

  # Número máximo de arquivos DLQ
  max_files: 10

  # Dias de retenção para arquivos DLQ
  retention_days: 7

  # Formato dos arquivos DLQ (json, text)
  format: "json"

  # Intervalo para flush de entradas para arquivo
  flush_interval: "30s"

  # Tamanho da fila em memória
  queue_size: 1000

  # Auto rotação quando arquivo atinge tamanho máximo
  auto_rotate: true

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE PERSISTÊNCIA DE BATCHES
# -----------------------------------------------------------------------------
batch_persistence:
  # Habilitar persistência de batches
  enabled: true

  # Diretório para backup de batches
  directory: "/app/batch_persistence"

  # TTL para batches persistidos
  ttl: "6h"

  # Número máximo de tentativas de reenvio
  max_retry_attempts: 5

  # Delay base para retry exponential backoff
  retry_base_delay: "2s"

  # Delay máximo entre retries
  retry_max_delay: "5m"

  # Intervalo de limpeza de batches expirados
  cleanup_interval: "1h"

  # Comprimir batches salvos
  compress_batches: true

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE VALIDAÇÃO DE TIMESTAMP
# -----------------------------------------------------------------------------
timestamp_validation:
  # Habilitar validação de timestamps
  enabled: true

  # Máximo de horas no passado aceitas
  max_past_hours: 24

  # Máximo de horas no futuro aceitas
  max_future_hours: 1

  # Timezone para validação (UTC, Local, America/New_York, etc.)
  timezone: "UTC"

  # Ação para timestamps inválidos (clamp, reject, warn)
  on_invalid_action: "clamp"

  # Formatos de timestamp suportados
  supported_formats:
    - "2006-01-02T15:04:05Z07:00"  # RFC3339
    - "2006-01-02 15:04:05"
    - "2006/01/02 15:04:05"
    - "Jan 2 15:04:05"             # Syslog

  # Clampar para tempo atual ou para bordas da janela válida
  clamp_to_current_time: true

  # Parse de timestamp de campos específicos
  timestamp_fields:
    - "timestamp"
    - "@timestamp"
    - "time"
    - "datetime"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE PROTEÇÃO CONTRA SELF-FEEDBACK
# -----------------------------------------------------------------------------
self_feedback_guard:
  # Habilitar proteção contra self-feedback
  enabled: true

  # Auto-detectar usando variáveis de ambiente
  auto_detect: true

  # Filtros por nome de container
  container_filters:
    - "ssw-logs-capture"
    - "log-capturer"
    - "logs-capture"
    - "log_capturer_go"

  # Filtros por path de arquivo
  path_filters:
    # - "/app/logs/output/*"
    # - "/var/log/ssw-logs-capture*"

  # Filtros por conteúdo da mensagem (regex)
  message_filters:
    # - "ssw-logs-capture"
    # - "Processing log entry"
    # - "Sent batch to.*loki"

  # Ação para logs detectados como self-feedback (drop, tag, warn)
  action: "drop"

  # Tag para identificar logs de self-feedback (quando action=tag)
  self_feedback_tag: "self_feedback"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE RATE LIMITING ADAPTATIVO
# -----------------------------------------------------------------------------
rate_limiting:
  # Habilitar rate limiting
  enabled: true

  # Rate inicial em requests por segundo
  initial_rps: 100

  # Rate máximo permitido
  max_rps: 1000

  # Tamanho do burst (rajadas)
  burst_size: 200

  # Latência alvo em millisegundos para adaptação
  latency_target_ms: 500

  # Período de medição para adaptação
  measurement_window: "60s"

  # Fator de suavização para mudanças (0.0-1.0)
  smoothing_factor: 0.1

  # Cooldown entre adaptações
  adaptation_cooldown: "30s"

  # Rate limiting por bytes (além de por request)
  bytes_per_second_limit: 10485760  # 10MB/s

  # Configurações por sink
  per_sink_limits:
    loki:
      rps: 500
      burst: 100
    local_file:
      rps: 1000
      burst: 200

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE COMPRESSÃO MULTI-ALGORITMO
# -----------------------------------------------------------------------------
compression:
  # Algoritmo padrão (gzip, zlib, zstd, lz4, snappy, auto)
  default_algorithm: "auto"

  # Habilitar seleção adaptativa baseada no conteúdo
  adaptive_enabled: true

  # Tamanho mínimo para aplicar compressão (bytes)
  min_bytes: 1024

  # Configurações por algoritmo
  algorithms:
    gzip:
      enabled: true
      level: 6  # 1-9 (1=fastest, 9=best compression)

    zlib:
      enabled: true
      level: 6

    zstd:
      enabled: true
      level: 3  # 1-22

    lz4:
      enabled: true
      level: 1  # 1-16

    snappy:
      enabled: true

  # Pool de workers para compressão
  worker_pool_size: 4

  # Configurações por sink
  per_sink_compression:
    loki:
      algorithm: "gzip"
      enabled: true
    local_file:
      algorithm: "auto"
      enabled: false

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE THROTTLING BASEADO EM CARGA
# -----------------------------------------------------------------------------
load_throttling:
  # Habilitar throttling baseado em carga do sistema
  enabled: true

  # Intervalo de monitoramento de métricas
  monitoring_interval: "5s"

  # Tamanho da janela deslizante para médias
  window_size: 12  # 12 * 5s = 1 minute

  # Thresholds de CPU (0.0-1.0)
  cpu_thresholds:
    warning: 0.7   # 70%
    critical: 0.9  # 90%

  # Thresholds de memória (0.0-1.0)
  memory_thresholds:
    warning: 0.8   # 80%
    critical: 0.95 # 95%

  # Threshold de tamanho da fila
  queue_size_thresholds:
    warning: 5000
    critical: 8000

  # Pesos para cálculo do load score
  load_weights:
    cpu: 0.4
    memory: 0.3
    queue_size: 0.3

  # Fator de throttling por nível de carga
  throttling_factors:
    normal: 1.0    # Sem throttling
    warning: 0.7   # Reduz para 70%
    critical: 0.3  # Reduz para 30%

  # Suavização de mudanças de throttling
  smoothing_enabled: true
  smoothing_factor: 0.2

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE SECRETS MANAGER
# -----------------------------------------------------------------------------
secrets:
  # Backend padrão (env, vault, aws, k8s)
  default_backend: "env"

  # Habilitar cache de secrets
  cache_enabled: true

  # TTL do cache de secrets
  cache_ttl: "5m"

  # Intervalo de limpeza do cache
  cache_cleanup_interval: "1m"

  # Configurações do Vault
  vault:
    enabled: false
    address: "http://vault:8200"
    token: ""
    mount_path: "secret"
    timeout: "30s"

    # Configurações TLS para Vault
    tls:
      enabled: false
      ca_cert: ""
      client_cert: ""
      client_key: ""

  # Configurações AWS Secrets Manager
  aws:
    enabled: false
    region: "us-east-1"
    access_key_id: ""
    secret_access_key: ""
    session_token: ""

  # Configurações Kubernetes Secrets
  k8s:
    enabled: false
    namespace: "default"
    kubeconfig_path: ""
    in_cluster: true

  # Prefixos organizacionais para secrets
  prefixes:
    database: "db/"
    api: "api/"
    external: "ext/"

  # Rotação automática de secrets
  auto_rotation:
    enabled: false
    interval: "24h"
    backends: ["vault", "aws"]

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE CIRCUIT BREAKER
# -----------------------------------------------------------------------------
circuit_breaker:
  # Configurações globais do circuit breaker
  global:
    enabled: true
    failure_threshold: 5      # Falhas consecutivas para abrir
    success_threshold: 3      # Sucessos para fechar
    timeout: "60s"           # Tempo no estado aberto
    half_open_max_calls: 10  # Máximo de calls no estado half-open

  # Configurações por sink
  per_sink:
    loki:
      failure_threshold: 3
      timeout: "30s"
    local_file:
      failure_threshold: 10
      timeout: "10s"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE HEALTH CHECKS
# -----------------------------------------------------------------------------
health_checks:
  # Habilitar health checks detalhados
  enabled: true

  # Intervalo entre health checks
  check_interval: "30s"

  # Timeout para cada health check
  check_timeout: "10s"

  # Componentes para verificar
  components:
    - "file_monitor"
    - "container_monitor"
    - "dispatcher"
    - "sinks"
    - "disk_space"
    - "memory_usage"
    - "queue_sizes"

  # Configurações de alertas
  alerts:
    # Habilitar alertas
    enabled: false

    # Webhook para envio de alertas
    webhook_url: ""

    # Intervalo mínimo entre alertas
    min_alert_interval: "5m"

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES AVANÇADAS
# -----------------------------------------------------------------------------
advanced:
  # Configurações de performance
  performance:
    # Número de CPU cores a usar (0 = auto-detect)
    max_procs: 0

    # Tamanho do buffer para channels
    channel_buffer_size: 1000

    # Habilitar profiling via pprof
    enable_pprof: false

    # Porta para pprof (se habilitado)
    pprof_port: 6060

  # Configurações de debug
  debug:
    # Habilitar logs de debug detalhados
    verbose_logging: true

    # Salvar dados de debug em arquivo
    save_debug_data: true

    # Diretório para dados de debug
    debug_data_dir: "/app/debug"

  # Configurações experimentais
  experimental:
    # Habilitar features experimentais
    enabled: false

    # Features específicas a habilitar
    features: []

# =============================================================================
# NOTAS DE CONFIGURAÇÃO:
# =============================================================================
#
# 1. FORMATOS DE TEMPO:
#    - Use sufixos: s (segundos), m (minutos), h (horas)
#    - Exemplos: "30s", "5m", "1h", "24h"
#
# 2. TAMANHOS:
#    - Valores em bytes ou use sufixos: KB, MB, GB
#    - Exemplos: 1024, "1KB", "10MB", "1GB"
#
# 3. PATHS:
#    - Use paths absolutos quando possível
#    - Paths relativos são relativos ao diretório de trabalho
#
# 4. REGEX:
#    - Use sintaxe Go regex (RE2)
#    - Teste regex em https://regex101.com/ (flavor: Go)
#
# 5. VARIÁVEIS DE AMBIENTE:
#    - Podem sobrescrever qualquer configuração usando UPPER_CASE
#    - Exemplo: APP_LOG_LEVEL=debug sobrescreve app.log_level
#
# 6. DOCKER COMPOSE:
#    - Monte este arquivo como volume: ./config.yml:/app/config.yml
#    - Configure variáveis de ambiente no docker-compose.yml
#
# 7. PRODUÇÃO:
#    - Revise todas as configurações antes de usar em produção
#    - Monitore logs e métricas após deployment
#    - Ajuste configurações baseado na carga real
#
# =============================================================================