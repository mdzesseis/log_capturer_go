name: Benchmark Comparison

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison

    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Baixar depend√™ncias
      run: go mod download

    - name: Executar benchmarks no branch atual
      run: |
        go test -bench=. -benchmem -run=^$ ./... > current_bench.txt 2>&1 || true
        cat current_bench.txt

    - name: Checkout branch main para compara√ß√£o
      if: github.event_name == 'pull_request'
      run: |
        git fetch origin main
        git checkout origin/main

    - name: Executar benchmarks no branch main
      if: github.event_name == 'pull_request'
      run: |
        go test -bench=. -benchmem -run=^$ ./... > main_bench.txt 2>&1 || true
        cat main_bench.txt

    - name: Checkout de volta para o branch do PR
      if: github.event_name == 'pull_request'
      run: |
        git checkout -

    - name: Instalar benchstat
      run: go install golang.org/x/perf/cmd/benchstat@latest

    - name: Comparar benchmarks
      if: github.event_name == 'pull_request'
      id: compare
      run: |
        echo "## üìä Benchmark Comparison" > benchmark_comment.md
        echo "" >> benchmark_comment.md

        if [ -f main_bench.txt ] && [ -f current_bench.txt ]; then
          echo "### Compara√ß√£o com branch main:" >> benchmark_comment.md
          echo '```' >> benchmark_comment.md
          $(go env GOPATH)/bin/benchstat main_bench.txt current_bench.txt >> benchmark_comment.md 2>&1 || echo "Benchstat comparison failed or no significant difference" >> benchmark_comment.md
          echo '```' >> benchmark_comment.md
          echo "" >> benchmark_comment.md

          # An√°lise de regress√£o
          echo "### üîç An√°lise de Regress√£o:" >> benchmark_comment.md

          # Verificar se houve degrada√ß√£o significativa (>10%)
          REGRESSION=$($(go env GOPATH)/bin/benchstat -alpha 0.05 main_bench.txt current_bench.txt 2>&1 | grep -E '\+[0-9]+\.[0-9]+%' | grep -v '\+[0-5]\.' || true)

          if [ -n "$REGRESSION" ]; then
            echo "‚ö†Ô∏è **ATEN√á√ÉO**: Poss√≠veis regress√µes de performance detectadas:" >> benchmark_comment.md
            echo '```' >> benchmark_comment.md
            echo "$REGRESSION" >> benchmark_comment.md
            echo '```' >> benchmark_comment.md
            echo "" >> benchmark_comment.md
            echo "Por favor, revise as mudan√ßas que podem ter impactado a performance." >> benchmark_comment.md
          else
            echo "‚úÖ Nenhuma regress√£o significativa de performance detectada." >> benchmark_comment.md
          fi
        else
          echo "‚ùå N√£o foi poss√≠vel comparar benchmarks (arquivos n√£o encontrados)" >> benchmark_comment.md
        fi

        echo "" >> benchmark_comment.md
        echo "### üìà Benchmarks Atuais:" >> benchmark_comment.md
        echo '```' >> benchmark_comment.md
        cat current_bench.txt >> benchmark_comment.md 2>&1 || echo "No benchmarks found" >> benchmark_comment.md
        echo '```' >> benchmark_comment.md

        cat benchmark_comment.md

    - name: Preparar artefatos
      run: |
        mkdir -p bench_artifacts
        [ -f current_bench.txt ] && cp current_bench.txt bench_artifacts/
        [ -f main_bench.txt ] && cp main_bench.txt bench_artifacts/
        [ -f benchmark_comment.md ] && cp benchmark_comment.md bench_artifacts/

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: bench_artifacts/
        retention-days: 30

    - name: Comment PR com resultados
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const commentBody = fs.readFileSync('benchmark_comment.md', 'utf8');

          // Buscar coment√°rios existentes do bot
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('üìä Benchmark Comparison')
          );

          if (botComment) {
            // Atualizar coment√°rio existente
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Criar novo coment√°rio
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Verificar regress√µes cr√≠ticas
      if: github.event_name == 'pull_request'
      run: |
        # Falhar o job se houver regress√µes cr√≠ticas (>20%)
        if [ -f main_bench.txt ] && [ -f current_bench.txt ]; then
          CRITICAL_REGRESSION=$($(go env GOPATH)/bin/benchstat -alpha 0.01 main_bench.txt current_bench.txt 2>&1 | grep -E '\+[2-9][0-9]\.[0-9]+%|\+[0-9]{3,}\.[0-9]+%' || true)

          if [ -n "$CRITICAL_REGRESSION" ]; then
            echo "‚ùå CRITICAL: Regress√£o de performance >20% detectada!"
            echo "$CRITICAL_REGRESSION"
            echo "Por favor, corrija antes de mergear."
            exit 1
          fi
        fi

  benchmark-continuous:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Executar benchmarks completos
      run: |
        mkdir -p benchmarks/results
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        go test -bench=. -benchmem -benchtime=10s -run=^$ ./... | tee "benchmarks/results/bench_${TIMESTAMP}.txt"

    - name: Upload benchmark baseline
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-baseline-${{ github.sha }}
        path: benchmarks/results/
        retention-days: 90

    - name: Commit resultados ao reposit√≥rio (opcional)
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if [ -d benchmarks/results ]; then
          git add benchmarks/results/ || true
          git diff --staged --quiet || git commit -m "chore: add benchmark results from ${{ github.sha }}" || true
          # Descomente a linha abaixo se quiser fazer push autom√°tico dos resultados
          # git push || true
        fi
