global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'log-capturer-cluster'
    environment: 'production'

# Rule files for alerting
rule_files:
  - "/etc/prometheus/alerts/rules.yml"

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
      # Timeout and path configuration
      timeout: 10s
      api_version: v2

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 30s
    scrape_timeout: 10s

  # Main log capturer application
  - job_name: 'log-capturer'
    static_configs:
      - targets: ['log_capturer_go:8001']
    scrape_interval: 10s
    scrape_timeout: 5s
    metrics_path: /metrics
    metric_relabel_configs:
      # Add component label for all log_capturer metrics
      - source_labels: [__name__]
        regex: 'log_capturer_.*'
        target_label: 'component'
        replacement: 'log_capturer'
      # Add instance label for clustering
      - source_labels: [__address__]
        target_label: 'instance'
        replacement: 'log_capturer_go'

  # Loki metrics
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: /metrics

  # Grafana metrics
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: /metrics

  # Kafka JMX metrics (via JMX Prometheus exporter)
  - job_name: 'kafka-jmx'
    static_configs:
      - targets: ['kafka:7071']
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /metrics

  # Zookeeper metrics (via JMX exporter)
  # - job_name: 'zookeeper'
  #   static_configs:
  #     - targets: ['zookeeper:9999']
  #   scrape_interval: 30s
  #   scrape_timeout: 10s
  #   metrics_path: /metrics

  # Loki storage monitor (if implemented)
  - job_name: 'loki_storage_monitor'
    static_configs:
      - targets: ['loki-monitor:9091']
    scrape_interval: 60s
    scrape_timeout: 15s
    metrics_path: /metrics
    # Only scrape if target is available
    honor_labels: true

# =============================================================================
# OPTIONAL EXPORTERS (commented out - add services to docker-compose first)
# =============================================================================

# Node Exporter - system metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node_exporter:9100']
    scrape_interval: 15s
    scrape_timeout: 10s

  # Kafka Exporter - Kafka cluster metrics
  - job_name: 'kafka-exporter'
    static_configs:
      - targets: ['kafka-exporter:9308']
    scrape_interval: 30s
    scrape_timeout: 10s

# MySQL Exporter - database metrics
# - job_name: 'mysql'
#   static_configs:
#     - targets: ['mysqld_exporter:9104']
#   scrape_interval: 30s
#   scrape_timeout: 10s

# OpenSIPS Exporter - SIP proxy metrics
# - job_name: 'opensips'
#   static_configs:
#     - targets: ['opensips_exporter:9434']
#   scrape_interval: 30s
#   scrape_timeout: 10s

# cAdvisor - container metrics
# - job_name: 'cadvisor'
#   static_configs:
#     - targets: ['cadvisor:8080']  # Standard port
#   scrape_interval: 30s
#   scrape_timeout: 15s
#   metric_relabel_configs:
#     # Drop high cardinality metrics to reduce load
#     - source_labels: [__name__]
#       regex: 'container_memory_failures_total|container_memory_mapped_file|container_memory_swap'
#       action: drop
#     # Keep only running containers
#     - source_labels: [container_label_com_docker_compose_service]
#       regex: '.+'
#       action: keep

# Docker State Exporter - container state metrics
# - job_name: 'docker_state'
#   static_configs:
#     - targets: ['docker_state_exporter:8080']
#   scrape_interval: 30s
#   scrape_timeout: 10s

# =============================================================================
# SERVICE DISCOVERY EXAMPLES (advanced configurations)
# =============================================================================

# File-based service discovery
# - job_name: 'file_sd'
#   file_sd_configs:
#     - files:
#         - '/etc/prometheus/targets/*.json'
#       refresh_interval: 30s

# Docker service discovery (requires Docker daemon access)
# - job_name: 'docker'
#   docker_sd_configs:
#     - host: unix:///var/run/docker.sock
#       refresh_interval: 30s
#   relabel_configs:
#     # Only scrape containers with prometheus.scrape=true label
#     - source_labels: [__meta_docker_container_label_prometheus_scrape]
#       regex: 'true'
#       action: keep
#     # Use custom port from label
#     - source_labels: [__meta_docker_container_label_prometheus_port]
#       regex: '(.+)'
#       target_label: '__address__'
#       replacement: '${1}:${2}'