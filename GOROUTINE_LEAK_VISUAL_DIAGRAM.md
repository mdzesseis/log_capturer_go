# GOROUTINE LEAK - DIAGRAMA VISUAL
**VisualizaÃ§Ã£o do problema e soluÃ§Ã£o**

---

## SITUAÃ‡ÃƒO NORMAL (SEM LEAK)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Container Monitor Thread                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ monitorContainer()
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      Rotation Loop (every 5 min)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Heartbeat Thread  â”‚      â”‚  Reader Thread     â”‚
    â”‚  (container life)  â”‚      â”‚  (stream life)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â”‚                           â”‚ reads logs
                â–¼                           â–¼
        heartbeatWg.Done()        readerWg.Done() âœ…
                                              â”‚
                                              â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚                      â”‚
                                  â–¼                      â–¼
                        readerWg.Wait() âœ…    Next Rotation âœ…
                        (completes)           (starts)
```

**Resultado**: Sistema funciona perfeitamente, rotaÃ§Ãµes ocorrem a cada 5 minutos.

---

## SITUAÃ‡ÃƒO COM BUG (LEAK)

### PRIMEIRA ROTAÃ‡ÃƒO (T+5min) - OK âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRIMEIRA ROTAÃ‡ÃƒO (OK)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+0s:    Stream opened
         Reader goroutine started
         Container generating logs actively

         Reader Thread:
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ for {               â”‚
         â”‚   select {          â”‚â—„â”€â”€â”€ Frequentemente aqui
         â”‚     case <-ctx:     â”‚     (verificando context)
         â”‚       return âœ…     â”‚
         â”‚     default:        â”‚
         â”‚   }                 â”‚
         â”‚                     â”‚
         â”‚   stream.Read() â”€â”€â–ºâ”‚â—„â”€â”€â”€ Ã€s vezes aqui
         â”‚ }                   â”‚     (lendo dados)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+299s:  Reader estÃ¡ no SELECT verificando context âœ…
T+300s:  streamCtx EXPIRES (5 min timeout)
         readerCtx.Done() fechado
         Reader detecta no SELECT âœ…
         Reader executa RETURN
         defer readerWg.Done() executado âœ…

         readerWg.Wait() completa âœ…
         Rotation registered âœ…
         Next rotation starts âœ…
```

**Por que funciona**: Reader estÃ¡ no SELECT quando timeout expira, detecta cancelamento imediatamente.

---

### SEGUNDA ROTAÃ‡ÃƒO (T+10min) - DEADLOCK âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SEGUNDA ROTAÃ‡ÃƒO (DEADLOCK)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+301s:  New stream opened
         New reader goroutine started
         logOptions.Since = lastRead (logs jÃ¡ foram lidos)
         Container tem POUCOS/ZERO logs novos

         Reader Thread:
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ for {                                   â”‚
         â”‚   select {                              â”‚
         â”‚     case <-ctx: return                  â”‚
         â”‚     default:                            â”‚
         â”‚   }                                     â”‚
         â”‚                                         â”‚
         â”‚   stream.Read() â”€â”€â”€â”                   â”‚
         â”‚                    â”‚                    â”‚
         â”‚                    â–¼                    â”‚
         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
         â”‚            â”‚  BLOCKED      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€  Reader STUCK aqui
         â”‚            â”‚  IN KERNEL    â”‚            aguardando dados
         â”‚            â”‚  I/O SYSCALL  â”‚            do Docker daemon
         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
         â”‚ }                                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+600s:  â° streamCtx EXPIRES (5 min timeout)
         stream.Close() called
         readerCancel() called
         readerCtx.Done() FECHADO

         âŒ MAS: Reader estÃ¡ em stream.Read() (KERNEL SPACE)
         âŒ NÃƒO estÃ¡ no SELECT
         âŒ NÃƒO verifica readerCtx.Done()
         âŒ syscall pode demorar para retornar

T+601s:  Main thread chama readerWg.Wait()

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  readerWg.Wait() â³              â”‚
         â”‚                                  â”‚
         â”‚  Aguardando...                   â”‚â—„â”€â”€â”€ DEADLOCK!
         â”‚  Reader count: 1                 â”‚     Trava AQUI
         â”‚  (nunca decrementa)              â”‚     para sempre
         â”‚                                  â”‚
         â”‚  â³â³â³â³â³â³â³â³               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+âˆ:     âŒ Reader goroutine VAZADA
         âŒ Rotation NUNCA registrada
         âŒ Next rotation NUNCA inicia
         âŒ Container PARADO de rotacionar
```

---

## ACUMULAÃ‡ÃƒO DE LEAKS (T+10min â†’ T+30min)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LEAK ACCUMULATION                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+5min:   Primeira rotaÃ§Ã£o OK para todos 50 containers âœ…

T+10min:  Segunda rotaÃ§Ã£o FALHA para todos 50 containers âŒ
          50 reader goroutines VAZADAS
          50 rotation loops TRAVADAS

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚Container1â”‚  â”‚Container2â”‚  â”‚Container3â”‚  ...  â”‚Container50â”‚
          â”‚          â”‚  â”‚          â”‚  â”‚          â”‚       â”‚          â”‚
          â”‚ Reader 1 â”‚  â”‚ Reader 1 â”‚  â”‚ Reader 1 â”‚       â”‚ Reader 1 â”‚
          â”‚ LEAKED âŒâ”‚  â”‚ LEAKED âŒâ”‚  â”‚ LEAKED âŒâ”‚       â”‚ LEAKED âŒâ”‚
          â”‚          â”‚  â”‚          â”‚  â”‚          â”‚       â”‚          â”‚
          â”‚ Rotation â”‚  â”‚ Rotation â”‚  â”‚ Rotation â”‚       â”‚ Rotation â”‚
          â”‚ STUCK âŒ â”‚  â”‚ STUCK âŒ â”‚  â”‚ STUCK âŒ â”‚       â”‚ STUCK âŒ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+15min:  Nenhuma terceira rotaÃ§Ã£o ocorre (loops travados)
          Leak permanece em 50 goroutines
          Mas outros componentes comeÃ§am a sentir impacto:

          Dispatcher:
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Queue crescendo...             â”‚
          â”‚ Workers ficando ocupados...    â”‚
          â”‚ Latency aumentando...          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+18min:  ğŸ”¥ THRESHOLD ATINGIDO
          Dispatcher sobrecarregado
          Contexts comeÃ§am a expirar em cascata

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ’¥ EXPLOSION POINT            â”‚
          â”‚                                â”‚
          â”‚  Goroutines: 1,400+ (+85)      â”‚
          â”‚  Errors: context timeout       â”‚
          â”‚  Status: DEGRADED              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+22min:  ğŸš¨ CRITICAL STATE
          213 "context deadline exceeded" errors
          Sistema entrando em falha cascata

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Container1: âŒ timeout        â”‚
          â”‚  Container2: âŒ timeout        â”‚
          â”‚  Container3: âŒ timeout        â”‚
          â”‚  ...                           â”‚
          â”‚  Container50: âŒ timeout       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+30min:  ğŸ”´ TEST FAILED
          Goroutines: 2,974 (+1,659)
          Growth rate: 55.30/min (27.6x acima do target)
          File Descriptors: +806
          Status: SYSTEM UNUSABLE
```

---

## SOLUÃ‡ÃƒO: TIMEOUT WRAPPER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SOLUÃ‡ÃƒO - TIMEOUT WRAPPER                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Reader Thread (COM FIX):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for {                                                         â”‚
â”‚   // Check context BEFORE read                               â”‚
â”‚   select {                                                    â”‚
â”‚     case <-readerCtx.Done():                                 â”‚
â”‚       return âœ…  // Exit immediately                         â”‚
â”‚     default:                                                  â”‚
â”‚   }                                                           â”‚
â”‚                                                               â”‚
â”‚   // Perform read with TIMEOUT                               â”‚
â”‚   readDone := make(chan readOp, 1)                           â”‚
â”‚                                                               â”‚
â”‚   go func() {                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     n, err := stream.Read(buf)   â”‚  Read Thread     â”‚        â”‚
â”‚     readDone <- readOp{n, err}   â”‚  (pode bloquear) â”‚        â”‚
â”‚   }()                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                               â”‚
â”‚   // Wait with TRIPLE protection                             â”‚
â”‚   select {                                                    â”‚
â”‚     case <-readerCtx.Done():                                 â”‚
â”‚       return âœ…  // Context cancelled                        â”‚
â”‚                                                               â”‚
â”‚     case <-time.After(30 * time.Second):                     â”‚
â”‚       return âœ…  // Read timeout - allow rotation            â”‚
â”‚                                                               â”‚
â”‚     case op := <-readDone:                                   â”‚
â”‚       // Process data âœ…                                     â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PROTEÃ‡Ã•ES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Context check ANTES do read       âœ…                    â”‚
â”‚ 2. Timeout de 30s no read            âœ…                    â”‚
â”‚ 3. Context check DURANTE wait        âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GARANTIAS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Reader SEMPRE termina (max 30s)                          â”‚
â”‚ âœ… readerWg.Done() SEMPRE executado                         â”‚
â”‚ âœ… readerWg.Wait() SEMPRE completa                          â”‚
â”‚ âœ… Rotations SEMPRE ocorrem                                 â”‚
â”‚ âœ… Zero goroutine leak                                      â”‚
â”‚ âœ… Zero deadlock                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## COMPARAÃ‡ÃƒO: ANTES vs DEPOIS

### ANTES (COM BUG)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TIMELINE: 30 MINUTOS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ T+0:    â–ˆâ–ˆâ–ˆâ–ˆ (1,315 goroutines - baseline)                    â”‚
â”‚ T+5:    â–ˆâ–ˆâ–ˆâ–ˆ (primeira rotaÃ§Ã£o OK)                            â”‚
â”‚ T+10:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (50 leaks - segunda rotaÃ§Ã£o falha)             â”‚
â”‚ T+15:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (leak estÃ¡vel, sistema degradando)             â”‚
â”‚ T+18:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (EXPLOSÃƒO - threshold atingido)           â”‚
â”‚ T+22:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (CRÃTICO - timeouts em massa)        â”‚
â”‚ T+30:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2,974 goroutines - FALHA)    â”‚
â”‚                                                                â”‚
â”‚ RotaÃ§Ãµes: 50 total (1 por container) âŒ                       â”‚
â”‚ Esperado: 300 total (6 por container)                         â”‚
â”‚ Deficit: 83% das rotaÃ§Ãµes faltando                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DEPOIS (COM FIX)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TIMELINE: 30 MINUTOS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ T+0:    â–ˆâ–ˆâ–ˆâ–ˆ (1,315 goroutines - baseline)                    â”‚
â”‚ T+5:    â–ˆâ–ˆâ–ˆâ–ˆ (primeira rotaÃ§Ã£o OK) âœ…                         â”‚
â”‚ T+10:   â–ˆâ–ˆâ–ˆâ–ˆ (segunda rotaÃ§Ã£o OK) âœ…                          â”‚
â”‚ T+15:   â–ˆâ–ˆâ–ˆâ–ˆ (terceira rotaÃ§Ã£o OK) âœ…                         â”‚
â”‚ T+20:   â–ˆâ–ˆâ–ˆâ–ˆ (quarta rotaÃ§Ã£o OK) âœ…                           â”‚
â”‚ T+25:   â–ˆâ–ˆâ–ˆâ–ˆ (quinta rotaÃ§Ã£o OK) âœ…                           â”‚
â”‚ T+30:   â–ˆâ–ˆâ–ˆâ–ˆ (1,350 goroutines - ESTÃVEL) âœ…                  â”‚
â”‚                                                                â”‚
â”‚ RotaÃ§Ãµes: 300+ total (6+ por container) âœ…                    â”‚
â”‚ Growth: +35 goroutines (+1.16/min) âœ…                         â”‚
â”‚ Status: SISTEMA ESTÃVEL âœ…                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MÃ‰TRICAS: ANTES vs DEPOIS

| MÃ©trica                    | ANTES (bug)  | DEPOIS (fix) | Melhoria |
|----------------------------|--------------|--------------|----------|
| Goroutine growth rate      | 55.30/min âŒ | 1.16/min âœ…  | 47.7x    |
| RotaÃ§Ãµes totais (30min)    | 50 âŒ        | 300+ âœ…      | 6x       |
| FD growth rate             | 26.8/min âŒ  | 0.5/min âœ…   | 53.6x    |
| Context timeout errors     | 213 âŒ       | 0 âœ…         | 100%     |
| Sistema estÃ¡vel por        | 18 min âŒ    | 60+ min âœ…   | 3.3x+    |

---

## CONCLUSÃƒO VISUAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  âŒ SEM FIX:  stream.Read() bloqueia â†’ deadlock â†’ leak          â”‚
â”‚                                                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚              â”‚ Reader   â”‚                                       â”‚
â”‚              â”‚ STUCK in â”‚                                       â”‚
â”‚              â”‚ Read()   â”‚â”€â”€â–º WaitGroup never decrements        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                   â”‚                                             â”‚
â”‚                   â–¼                                             â”‚
â”‚              DEADLOCK â”€â”€â–º Rotations stop â”€â”€â–º Goroutines leak   â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âœ… COM FIX:  Timeout wrapper â†’ reader sempre termina â†’ OK      â”‚
â”‚                                                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚              â”‚ Reader   â”‚                                       â”‚
â”‚              â”‚ with 30s â”‚                                       â”‚
â”‚              â”‚ timeout  â”‚â”€â”€â–º Always returns                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                   â”‚                                             â”‚
â”‚                   â–¼                                             â”‚
â”‚              WaitGroup decrements â”€â”€â–º Rotation continues â”€â”€â–º âœ… â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**AÃ‡ÃƒO NECESSÃRIA**: Implementar timeout wrapper no `stream.Read()` ASAP.

**IMPACTO**: Sistema passarÃ¡ de FALHA (27.6x leak rate) para ESTÃVEL (<2/min leak rate).

**COMPLEXIDADE**: MÃ©dia (4-6 horas)

**RISCO**: Baixo (fix conservador com timeout de 30s)

---

**Preparado por**: workflow-coordinator
**Documento**: Diagrama visual para facilitar compreensÃ£o
**Objetivo**: Comunicar problema e soluÃ§Ã£o de forma clara e visual
