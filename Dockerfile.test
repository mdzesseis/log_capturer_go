# Dockerfile para container de testes sidecar
FROM golang:1.21-alpine AS test-builder

# Instalar dependências para testes
RUN apk add --no-cache \
    git \
    gcc \
    musl-dev \
    docker-cli \
    curl \
    jq \
    bash

# Instalar ferramentas de teste Go
RUN go install github.com/onsi/ginkgo/v2/ginkgo@latest && \
    go install github.com/onsi/gomega/...@latest && \
    go install github.com/axw/gocov/gocov@latest && \
    go install github.com/AlekSi/gocov-xml@latest && \
    go install github.com/matm/gocov-html@latest && \
    go install github.com/wadey/gocovmerge@latest && \
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

WORKDIR /app

# Copiar go.mod e go.sum primeiro para cache de dependências
COPY go.mod go.sum ./
RUN go mod download

# Copiar código fonte
COPY . .

# Criar diretórios para testes e reports
RUN mkdir -p /app/test-results /app/coverage /app/test-data

# Container final para execução de testes
FROM golang:1.21-alpine AS test-runner

RUN apk add --no-cache \
    bash \
    curl \
    jq \
    docker-cli \
    git

# Copiar ferramentas instaladas
COPY --from=test-builder /go/bin/* /usr/local/bin/

# Copiar aplicação e testes
COPY --from=test-builder /app /app
WORKDIR /app

# Criar diretórios necessários
RUN mkdir -p \
    /app/test-results \
    /app/coverage \
    /app/test-data \
    /app/logs \
    /app/positions \
    /app/dlq \
    /app/batch_persistence \
    /tmp/test-files

# Script de entrada para testes
COPY test-scripts/test-runner.sh /usr/local/bin/test-runner.sh
RUN chmod +x /usr/local/bin/test-runner.sh

# Configurar variáveis de ambiente para testes
ENV GO_ENV=test
ENV CGO_ENABLED=0
ENV GOOS=linux

# Expor porta para health check do sidecar
EXPOSE 9090

# Comando padrão
CMD ["test-runner.sh"]

# Labels para identificação
LABEL maintainer="SSW Logs Capture Team"
LABEL description="Sidecar container for comprehensive testing"
LABEL version="1.0.0"